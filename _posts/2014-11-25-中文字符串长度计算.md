---
layout: post
title: 中文文本长度计算
category: PHP
tags: 编码
---



##### 我有一段文本：
 
	我是<<一只小小小小&鸟。
	我是——一只、小小“小小”鸟。
	我是《一只》小小‘小小’鸟。
	我是    一只小小&nbsp;小小鸟。

##### js校验

	str = str.replace(/\s/g, "");//去除空格，制表符(Tab)，换行符，中文全角空格等？？？？
	if(str.length<200)//length会将所有中英文符号都算1个字
	
##### myEditor编辑后提交过来的代码是这样的：

myEditor会添加html作为样式，而为了防止混淆，文本中原先的符号被编码。

	<p> 我是&lt;&lt;一只小小小小&amp;鸟。</p> <p> 我是&mdash;&mdash;一只、小小&ldquo;小小&rdquo;鸟。</p> <p> 我是《一只》小小&lsquo;小小&rsquo;鸟。</p> <p> 我是&nbsp;&nbsp;&nbsp; 一只小小&amp;nbsp;小小鸟。</p>


##### 计算字符数之前要预处理一下，


	function html_char_replace($content = "") {
        $content = strip_tags($content);//去掉myEditor附加的html标记
        $content = html_entity_decode($content,ENT_COMPAT | ENT_HTML401,'UTF-8');//将&nbsp;&quot;等转成html字符,php5.4+默认utf8,之前的版本使用ISO-8859-1，所以指定一下
        $find = array(
            ' ',
            "\t",
            "\n",
            "\r",
            chr(0xC2).chr(0xA0),
        );
        $replace = array('');
        $content = str_replace($find,$replace,$content);//去掉空格、回车
        return $content;
	}
	
##### 知识点
 
1. 为什么没用htmlspecialchars_decode($content)?

	因为很多特殊字符(如 & nbsp; & gt;)无法转换 
	
	<http://www.utexas.edu/learn/html/spchar.html>

2. html_entity_decode($content)发现文本被转化成

		我是<<一只小小小小&鸟。
		我是&mdash;&mdash;一只、小小&ldquo;小小&rdquo;鸟。
		我是《一只》小小&lsquo;小小&rsquo;鸟。
		我是��� 一只小小&nbsp;小小鸟。

	于是查看了文档换成`html_entity_decode($content,ENT_COMPAT | ENT_HTML401,'UTF-8')`

	> php5.4+默认utf8,之前的版本使用ISO-8859-1

3. str_replace(' ','',$content)无法去除空格呢，
	
	打印发现4个空格变成 0xC2 0xC2 0xC2 0x20，最后改成`str_replace(array(' ',chr(0xC2).chr(0xA0)),'',$content);` 
    
	> UTF-8这种编码里面，存在一个特殊的字符，其编码是“`0xC2 0xA0`”，转换成字符的时候，表现为一个空格，和普通的半角空格“ ”（ASCII码：`0x20`）一样，唯一的不同是它的宽度不会被压缩，因此常常用于网页排版（“硬空格” 如首行缩进）。而GB2312、Unicode之类的编码并没有这个字符，因此UTF-8转码后，这个字符就会被替换成为乱码问号。

4. 控制字符(即不可显示字符，如\r\n) <http://ascii.911cha.com/?year=A0>也会被计算字符

		我是<<一只小小小小&鸟。
		我是——一只、小小“小小”鸟。
		
	实际为
	
		我是<<一只小小小小&鸟。\r\n
		\t我是——一只、小小“小小”鸟。

	* \r  归位键  1101
	* \n  换行键  1010
	* \t  水平定位符 1001


##### 最后，计算字符数（中文及符号算1个，英文及符号算0.5个）

没有用`mb_strlen($content, 'utf-8')`//所有中英文、符号、控制字符都算1个字符

	function mb_stringlen($str){
        $strlen = strlen($str);
        $charlen = 0;
        $cut = false;
        for($i=0;$i<$strlen;)
        {
            $charAt = ord($str[$i]);
            if(($charAt & 0xfe) == 0xfe)//占七个字节的汉字1111 1110
            {
                $i+=7;
                $charlen+=2;
            }
            else if(($charAt & 0xfc) == 0xfc)//占六个字节的汉字1111 1100
            {
                $i+=6;
                $charlen+=2;
            }
            else if(($charAt & 0xf8) == 0xf8)//占五个字节的汉字1111 1000
            {
                $i+=5;
                $charlen+=2;
            }
            else if(($charAt & 0xf0) == 0xf0)//占四个字节的汉字1111 0000
            {
                $i+=4;
                $charlen+=2;
            }
            else if(($charAt & 0xe0) == 0xe0)//占三个字节的汉字1110 0000
            {
                $i+=3;
                $charlen+=2;
            }
            else if(($charAt & 0xc0) == 0xc0)//占两个字节的汉字1100 0000
            {
                $i+=2;
                $charlen+=2;
            }
            else if(($charAt | 0x1f) == 0x1f)//控制符(换行等)0x00~0x1f
            {
                $i++;
                continue;
            }
            else//($charAt < 128)//普通字符
            {
                $i++;
                $charlen ++;
                //echo $i." ".decbin($charAt)." | ";
            }
        }
        $num = round($charlen/2,1);
        if($num == 0.5) {
            return 1;
        }
        return $num;
    }
    
计算得出54个字，详细内容为：
	
	0  11100110 230 =>>= 2    我
	3  11100110 230 =>>= 4    是
	6  111100 60 =>>= 5       <
	7  111100 60 =>>= 6       <
	8  11100100 228 =>>= 8    一
	11  11100101 229 =>>= 10  只
	14  11100101 229 =>>= 12  小
	17  11100101 229 =>>= 14  小
	20  11100101 229 =>>= 16  小
	23  11100101 229 =>>= 18  小
	26  100110 38 =>>= 19     &
	27  11101001 233 =>>= 21  鸟
	30  11100011 227 =>>= 23  。
	33  11100110 230 =>>= 25  我
	36  11100110 230 =>>= 27  是
	39  11100010 226 =>>= 29  —
	42  11100010 226 =>>= 31  —
	45  11100100 228 =>>= 33  一
	48  11100101 229 =>>= 35  只
	51  11100011 227 =>>= 37  、
	54  11100101 229 =>>= 39  小
	57  11100101 229 =>>= 41  小
	60  11100010 226 =>>= 43  “
	63  11100101 229 =>>= 45  小
	66  11100101 229 =>>= 47  小
	69  11100010 226 =>>= 49  ”
	72  11101001 233 =>>= 51  鸟
	75  11100011 227 =>>= 53  。
	78  11100110 230 =>>= 55  我
	81  11100110 230 =>>= 57  是
	84  11100011 227 =>>= 59  《
	87  11100100 228 =>>= 61  一
	90  11100101 229 =>>= 63  只
	93  11100011 227 =>>= 65   》
	96  11100101 229 =>>= 67  小
	99  11100101 229 =>>= 69  小
	102  11100010 226 =>>= 71 ‘
	105  11100101 229 =>>= 73  小
	108  11100101 229 =>>= 75  小
	111  11100010 226 =>>= 77  ’
	114  11101001 233 =>>= 79  鸟
	117  11100011 227 =>>= 81  。
	120  11100110 230 =>>= 83  我
	123  11100110 230 =>>= 85  是
	126  11100100 228 =>>= 87  一
	129  11100101 229 =>>= 89  只
	132  11100101 229 =>>= 91  小
	135  11100101 229 =>>= 93  小
	138  100110 38 =>>= 94     &
	139  1101110 110 =>>= 95   n
	140  1100010 98 =>>= 96    b
	141  1110011 115 =>>= 97   s
	142  1110000 112 =>>= 98   p
	143  111011 59 =>>= 99     ;
	144  11100101 229 =>>= 101  小
	147  11100101 229 =>>= 103  小
	150  11101001 233 =>>= 105  鸟
	153  11100011 227 =>>= 107  。


	13----1101>>34=>>=23       归位键（不算）
	10----1010>>35=>>=23       换行键（不算）
	13----1101>>36=>>=23       归位键（不算）
	10----1010>>37=>>=23       换行键（不算）
	9----1001>>38=>>=23        水平定位符（不算）
	
194----11000010>>143=>>=87  空格
194----11000010>>145=>>=89  空格
194----11000010>>147=>>=91  空格
32----100000>>148=>>=92     空格

